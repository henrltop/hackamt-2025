{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Distribuição de Vacinas - Vacinaí{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Distribuição de Vacinas para UBSs</h1>
        <a href="{% url 'admin_cadastros' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar
        </a>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Selecionar Lote para Distribuição</h5>
        </div>
        <div class="card-body">
            <form method="post" id="form-selecionar-lote">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="tipo_imunobiologico" class="form-label">Tipo de Vacina:</label>
                            <select name="tipo_imunobiologico" id="tipo_imunobiologico" class="form-select" required>
                                <option value="">Selecione uma vacina</option>
                                {% for tipo in tipos_imuno %}
                                <option value="{{ tipo.id }}">{{ tipo.nome }} - {{ tipo.fabricante }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="lote" class="form-label">Lote:</label>
                            <select name="lote" id="lote" class="form-select" required disabled>
                                <option value="">Selecione um lote</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            <label for="quantidade_total" class="form-label">Quantidade em Estoque:</label>
                            <input type="text" id="quantidade_total" class="form-control" readonly>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            <label for="validade" class="form-label">Data de Validade:</label>
                            <input type="text" id="validade" class="form-control" readonly>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            <label for="doses_por_frasco" class="form-label">Doses por Frasco:</label>
                            <input type="text" id="doses_por_frasco" class="form-control" readonly>
                        </div>
                    </div>
                </div>
                <div class="d-grid mt-3">
                    <button type="button" id="btn-continuar" class="btn btn-primary" disabled>Continuar para Distribuição</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card mb-4" id="card-distribuicao" style="display: none;">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Distribuir para UBSs</h5>
        </div>
        <div class="card-body">
            <form method="post" action="{% url 'salvar_distribuicao' %}" id="form-distribuicao">
                {% csrf_token %}
                <input type="hidden" name="lote_id" id="lote_id">
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h5 class="alert-heading">Informações do Lote</h5>
                            <p><strong>Vacina:</strong> <span id="info-vacina"></span></p>
                            <p><strong>Lote:</strong> <span id="info-lote"></span></p>
                            <p><strong>Validade:</strong> <span id="info-validade"></span></p>
                            <p><strong>Quantidade disponível:</strong> <span id="info-quantidade"></span> frascos (<span id="info-doses"></span> doses)</p>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="tabela-distribuicao">
                        <thead class="table-primary">
                            <tr>
                                <th>UBS</th>
                                <th>Endereço</th>
                                <th>Quantidade atual</th>
                                <th>Quantidade a distribuir</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ubs in unidades_saude %}
                            <tr>
                                <td>{{ ubs.nome }}</td>
                                <td>{{ ubs.endereco }}, {{ ubs.bairro.nome }}</td>
                                <td id="atual-{{ ubs.id }}">0</td>
                                <td>
                                    <div class="input-group">
                                        <input type="number" name="quantidade_{{ ubs.id }}" id="quantidade_{{ ubs.id }}" class="form-control quantidade-distribuir" min="0" value="0">
                                        <span class="input-group-text">frascos</span>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-info">
                                <th colspan="3" class="text-end">Total a distribuir:</th>
                                <th id="total-distribuicao">0 frascos</th>
                            </tr>
                            <tr class="table-warning">
                                <th colspan="3" class="text-end">Restante no estoque central:</th>
                                <th id="restante-estoque">0 frascos</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="form-group">
                            <label for="observacoes" class="form-label">Observações:</label>
                            <textarea name="observacoes" id="observacoes" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <button type="button" id="btn-voltar" class="btn btn-secondary w-100">Voltar</button>
                    </div>
                    <div class="col-md-6">
                        <button type="submit" id="btn-confirmar" class="btn btn-success w-100">Confirmar Distribuição</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Quando o tipo de imunobiológico é selecionado, carrega os lotes disponíveis
        document.getElementById('tipo_imunobiologico').addEventListener('change', function() {
            const tipoId = this.value;
            if (tipoId) {
                // Habilitar select de lotes
                const loteSelect = document.getElementById('lote');
                loteSelect.disabled = false;
                loteSelect.innerHTML = '<option value="">Carregando lotes...</option>';
                
                console.log("Buscando lotes para o tipo ID:", tipoId);
                
                // Buscar lotes via API
                fetch(`/estoque/api/lotes-por-tipo/${tipoId}/`)
                    .then(response => {
                        console.log("Status da resposta:", response.status);
                        if (!response.ok) {
                            throw new Error('Erro ao carregar lotes. Status: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Dados recebidos:", data);
                        loteSelect.innerHTML = '<option value="">Selecione um lote</option>';
                        
                        if (!Array.isArray(data)) {
                            console.error("Dados recebidos não são um array:", data);
                            loteSelect.innerHTML = '<option value="">Erro no formato dos dados</option>';
                            loteSelect.disabled = true;
                            return;
                        }
                        
                        if (data.length === 0) {
                            console.log("Nenhum lote encontrado para este tipo");
                            loteSelect.innerHTML = '<option value="">Nenhum lote disponível</option>';
                            loteSelect.disabled = true;
                        } else {
                            data.forEach(lote => {
                                if (!lote || !lote.numero_lote) {
                                    console.error("Lote inválido:", lote);
                                    return;
                                }
                                
                                console.log("Adicionando lote:", lote.numero_lote, "com", lote.quantidade_frascos, "frascos");
                                
                                const option = document.createElement('option');
                                option.value = lote.id;
                                option.textContent = `${lote.numero_lote} - ${lote.quantidade_frascos} frascos`;
                                option.dataset.quantidade = lote.quantidade_frascos;
                                option.dataset.validade = lote.data_validade;
                                option.dataset.doses = lote.tipo_imunobiologico.doses_por_frasco;
                                option.dataset.vacina = lote.tipo_imunobiologico.nome;
                                option.dataset.fabricante = lote.tipo_imunobiologico.fabricante;
                                loteSelect.appendChild(option);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao carregar lotes:', error);
                        loteSelect.innerHTML = '<option value="">Erro ao carregar lotes</option>';
                        loteSelect.disabled = true;
                        alert('Ocorreu um erro ao carregar os lotes: ' + error.message);
                    });
            } else {
                // Se nenhum tipo selecionado, desabilitar select de lotes
                const loteSelect = document.getElementById('lote');
                loteSelect.disabled = true;
                loteSelect.innerHTML = '<option value="">Selecione um lote</option>';
            }
        });
        
        // Quando o lote é selecionado, exibe informações e habilita botão de continuar
        document.getElementById('lote').addEventListener('change', function() {
            const loteId = this.value;
            if (loteId) {
                const option = this.options[this.selectedIndex];
                document.getElementById('quantidade_total').value = option.dataset.quantidade + ' frascos';
                document.getElementById('validade').value = option.dataset.validade;
                document.getElementById('doses_por_frasco').value = option.dataset.doses + ' doses';
                
                // Habilitar botão de continuar
                document.getElementById('btn-continuar').disabled = false;
            } else {
                document.getElementById('quantidade_total').value = '';
                document.getElementById('validade').value = '';
                document.getElementById('doses_por_frasco').value = '';
                
                // Desabilitar botão de continuar
                document.getElementById('btn-continuar').disabled = true;
            }
        });
        
        // Botão de continuar para distribuição
        document.getElementById('btn-continuar').addEventListener('click', function() {
            const loteSelect = document.getElementById('lote');
            const option = loteSelect.options[loteSelect.selectedIndex];
            
            // Preencher informações no formulário de distribuição
            document.getElementById('lote_id').value = loteSelect.value;
            document.getElementById('info-vacina').textContent = option.dataset.vacina + ' (' + option.dataset.fabricante + ')';
            document.getElementById('info-lote').textContent = loteSelect.options[loteSelect.selectedIndex].text.split(' - ')[0];
            document.getElementById('info-validade').textContent = option.dataset.validade;
            document.getElementById('info-quantidade').textContent = option.dataset.quantidade;
            document.getElementById('info-doses').textContent = option.dataset.quantidade * option.dataset.doses;
            
            // Mostrar formulário de distribuição
            document.getElementById('card-distribuicao').style.display = 'block';
            
            // Obter informações atuais de estoque das UBSs
            fetch(`/estoque/api/estoque-ubs-por-lote/${loteSelect.value}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao carregar estoques. Status: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    // Preencher quantidade atual para cada UBS
                    data.forEach(item => {
                        const cel = document.getElementById('atual-' + item.unidade_id);
                        if (cel) {
                            cel.textContent = item.quantidade_frascos;
                        }
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar estoques:', error);
                });
            
            // Inicializar contadores
            atualizarTotais();
            
            // Scroll até o formulário de distribuição
            document.getElementById('card-distribuicao').scrollIntoView({ behavior: 'smooth' });
        });
        
        // Voltar para seleção de lote
        document.getElementById('btn-voltar').addEventListener('click', function() {
            document.getElementById('card-distribuicao').style.display = 'none';
            document.getElementById('form-selecionar-lote').scrollIntoView({ behavior: 'smooth' });
        });
        
        // Atualizar totais quando as quantidades são alteradas
        const inputs = document.querySelectorAll('.quantidade-distribuir');
        inputs.forEach(input => {
            input.addEventListener('input', atualizarTotais);
        });
        
        // Validar formulário antes de enviar
        document.getElementById('form-distribuicao').addEventListener('submit', function(e) {
            const restante = parseInt(document.getElementById('restante-estoque').dataset.restante || 0);
            if (restante < 0) {
                e.preventDefault();
                alert('A quantidade total a distribuir não pode ser maior que a quantidade disponível.');
            }
        });
        
        // Função para atualizar totais
        function atualizarTotais() {
            const loteSelect = document.getElementById('lote');
            const quantidadeTotal = parseInt(loteSelect.options[loteSelect.selectedIndex].dataset.quantidade);
            
            let totalDistribuir = 0;
            document.querySelectorAll('.quantidade-distribuir').forEach(input => {
                totalDistribuir += parseInt(input.value || 0);
            });
            
            const restante = quantidadeTotal - totalDistribuir;
            
            document.getElementById('total-distribuicao').textContent = totalDistribuir + ' frascos';
            document.getElementById('restante-estoque').textContent = restante + ' frascos';
            document.getElementById('restante-estoque').dataset.restante = restante;
            
            // Destacar se estiver distribuindo mais do que o disponível
            if (restante < 0) {
                document.getElementById('restante-estoque').classList.add('text-danger');
                document.getElementById('restante-estoque').classList.remove('text-dark');
                document.getElementById('btn-confirmar').disabled = true;
            } else {
                document.getElementById('restante-estoque').classList.remove('text-danger');
                document.getElementById('restante-estoque').classList.add('text-dark');
                document.getElementById('btn-confirmar').disabled = false;
            }
        }
    });
</script>
{% endblock %}